---
title: "Covid-19 analysis"
author: "Caleb Moses"
date: "`r format(Sys.Date(), '%d %B %Y')`"
knit: "bookdown::render_book"
output:
    bookdown::gitbook:
        self_contained: false
        pandoc_args: ["--verbose", "--log=pandoc.log"]
documentclass: book
link-citations: yes
github-repo: mathematiguy/covid-19
description: "This report analyses publicly available covid 19 data"
---

# Introduction

```{r}

library(yaml)
library(here)
library(tidyverse)
library(data.table)

source(here('R/get_odata_fun.R'), local=TRUE)
source(here('R/get_odata_catalogue_fun.R'), local=TRUE)
options(tibble.width = Inf, mc.cores = parallel::detectCores()-1)

credentials = read_yaml(here('credentials.yaml'))

# Set default ggplot theme
theme_set(
    theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5)) +
    theme(text = element_text(size = 20))
)

# Set notebook options
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, progress=TRUE, verbose=TRUE, cache.extra = knitr::rand_seed)

```

I want to build an SIR model for the covid 19 response but I need the right data in order to do it.

To get started I need the following datasets:

- NZ Population by region + ethnicity + age
- Daily case counts by region + ethnicity (at least) + age (preferably) [check]
- Hospitalisations by region + ethnicity (at least) + age (preferably)
- Deaths by region + ethnicity (at least) + age (preferably)

Lets start this by selecting a simple subset of the data that will be easier to analyse. 
Then we can chuck it into julia and see what we can do there.

```{r}

cases_by_dhb_over_time <- read_csv(here('nz-covid19-data-auto/cases_by_DHB_over_time.csv'))

auckland_cases <- cases_by_dhb_over_time %>%
    filter(DHB=='Auckland' & Date > as.Date('2021-08-10')) %>%

write_csv(auckland_cases, here('data/auckland_cases.csv'))

```

```{r}


# Get the SIR model data
testing_data <-  Filter(
    function(x)!all(is.na(x)),
    get_odata(
        service = "https://api.stats.govt.nz/opendata/v1",
        endpoint = "Covid-19Indicators",
        entity = "Observations",
        query_option = "$filter=(
                     ResourceID eq 'CPCOV1' and
                     Period ge 2021-08-10
                   )
            &$select=Period,Label1,Value",
        service_api_key = credentials$stats_nz_api_key)) %>%
    as_tibble() %>%
    rename(Count = Value,
           Day = Period)

testing_data %>%
    write_csv(here('data/testing.csv'))

```
